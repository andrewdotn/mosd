SHELL = /bin/bash -eu

PWD = $(dir $(lastword $(MAKEFILE_LIST)))
LIBARCHIVE = $(PWD)/../external/libarchive-2.8.3-install

CFLAGS := -W -Wall -Wextra -Wformat=2 -MD \
	  -I$(shell /usr/libexec/java_home)/include \
	  -I$(shell /usr/libexec/java_home)/include/darwin \
	  -I$(LIBARCHIVE)/include \
	  -g3 -O3
LDFLAGS = -L$(LIBARCHIVE)/lib -larchive

SRCS = \
       arinspect.c \
       net_subjoin_mosd_ArchiveInspector.c \
       net_subjoin_mosd_JNITest.c \


all: libmosd.jnilib mosd_jni.jar testprog

testprog: arinspect.o testprog.o

libmosd.jnilib: ${SRCS:%.c=%.o}
	gcc ${CFLAGS} -shared $^ -o $@ ${LDFLAGS}

net_subjoin_mosd_ArchiveInspector.c: \
    net_subjoin_mosd_ArchiveInspector.h \
    net_subjoin_mosd_ArchiveInspectorTest.h
net_subjoin_mosd_JNITest.c: net_subjoin_mosd_JNITest.h

mosd_jni.jar:
	echo 'This is a dummy jar to give something to attach a native \
library location to in Eclipse.' > mosd_jni.txt
	jar cf $@ mosd_jni.txt
	rm -f mosd_jni.txt

%.h:
	../javatool javah $(shell echo $* | sed -e s,_,.,g)

clean:
	rm -f *.d *.jnilib *.o
	grep -ZFl '/* DO NOT EDIT THIS FILE - it is machine generated */' \
	    -- *.h | xargs -0 rm -f --

-include ${SRCS:%.c=%.d}
-include testprog.d
